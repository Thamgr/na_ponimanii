# На понимании (Na Ponimanii)

## Telegram Bot с FastAPI интеграцией

Этот проект представляет собой интеграцию Telegram-бота с FastAPI сервером. Бот пересылает все входящие сообщения на FastAPI сервер, который обрабатывает их и отправляет ответ обратно пользователю через Telegram Bot API.

### Установка и запуск

#### Получение токена от BotFather

1. Откройте Telegram и найдите [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания нового бота:
   - Введите имя бота (например, "На понимании Бот")
   - Введите username для бота (должен заканчиваться на "bot", например, "na_ponimanii_bot")
4. После успешного создания BotFather выдаст вам токен, который выглядит примерно так: `1234567890:ABCDefGhIJKlmNoPQRsTUVwxyZ`
5. Сохраните этот токен, он понадобится для запуска бота

#### Настройка проекта

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Откройте файл `config.py` и замените значение переменной `TOKEN` на полученный от BotFather токен:
```python
TOKEN = "ВАШ_ТОКЕН_ЗДЕСЬ"
```

Примечание: Файл `config.py` добавлен в `.gitignore`, поэтому ваш токен не будет отправлен в репозиторий при пуше на GitHub.

#### Запуск приложения

1. Запустите FastAPI сервер:
```bash
python app.py
```

2. В отдельном терминале запустите Telegram бота:
```bash
python telegram_bot.py
```

После запуска бот будет:
- Пересылать все входящие сообщения на FastAPI сервер, который будет отвечать пользователю фразой "Получено: <текст сообщения>"
- Пересылать команды на FastAPI сервер для обработки

#### Архитектура приложения

Приложение использует следующую архитектуру:

1. **Telegram Bot** (telegram_bot.py):
   - Принимает сообщения и команды от пользователей
   - Пересылает их на FastAPI сервер для обработки
   - Не взаимодействует напрямую с базой данных

2. **FastAPI Server** (app.py):
   - Обрабатывает запросы от бота через специализированные эндпоинты:
     - `/bot/add_topic` - для добавления новой темы
     - `/bot/list_topics` - для получения списка тем
   - Взаимодействует с базой данных
   - Возвращает структурированные данные боту

3. **Telegram Bot** (telegram_bot.py):
   - Принимает сообщения и команды от пользователей
   - Отправляет запросы на сервер для обработки данных
   - Форматирует полученные от сервера данные в сообщения
   - Отправляет отформатированные сообщения пользователям

4. **База данных** (database.py):
   - Хранит информацию о темах пользователей
   - Предоставляет API для работы с данными

5. **LLM Сервис** (llm_service.py):
   - Взаимодействует с внешним LLM API для генерации объяснений
   - Предоставляет функцию generate_explanation для получения объяснений тем
   - Обрабатывает ошибки сети и API

#### Команды бота

- `/start` - начать работу с ботом и получить приветственное сообщение
- `/add <тема>` - добавить новую тему для изучения (например, `/add Python`)
- `/list` - показать список всех сохраненных тем
- `/topic` - получить объяснение случайной темы и удалить её из списка

### Конфигурация через переменные окружения

Вы можете настроить приложение, используя следующие переменные окружения:

- `TELEGRAM_TOKEN` - токен вашего Telegram бота
- `API_HOST` - хост для FastAPI сервера (по умолчанию "0.0.0.0")
- `API_PORT` - порт для FastAPI сервера (по умолчанию 8000)

Для удобства вы можете создать файл `.env` в корне проекта и указать в нем переменные окружения:

```
TELEGRAM_TOKEN=ваш_токен_здесь
API_HOST=127.0.0.1
API_PORT=8000
DB_PATH=data.db
LLM_API_KEY=your_api_key_here
LLM_API_BASE=https://api.openai.com/v1
LLM_MODEL=gpt-3.5-turbo
LLM_TEMPERATURE=0.7
LLM_MAX_TOKENS=1024
```

### Дальнейшее развитие

В будущем планируется добавить:
- Поиск тем по ключевым словам
- Возможность удаления тем
- Интеграция с другими источниками информации
- Добавление дополнительных команд и функциональности

### База данных

Проект использует SQLAlchemy ORM для работы с базой данных SQLite. База данных хранит информацию о темах, которые пользователи хотят изучить.

#### Структура базы данных

- Таблица `topics`:
  - `id` - первичный ключ, автоинкрементный
  - `user_id` - ID пользователя Telegram
  - `title` - название темы
  - `explanation` - объяснение темы, сгенерированное LLM
  - `created_at` - время создания записи

#### Использование базы данных

Для инициализации базы данных выполните:

```bash
python database.py
```

#### API для работы с базой данных

В модуле `database.py` реализованы следующие функции:

- `init_db()` - инициализация базы данных (создание таблиц)
- `add_topic(user_id: int, title: str, explanation: Optional[str] = None)` - добавление новой темы
- `update_topic_explanation(topic_id: int, explanation: str)` - обновление объяснения темы
- `get_topic(topic_id: int)` - получение темы по ID
- `list_topics(user_id: int)` - получение списка тем пользователя

#### API для работы с LLM

В модуле `llm_service.py` реализованы следующие функции:

- `generate_explanation(topic: str)` - генерация объяснения для заданной темы

### Процесс работы с темами

1. Пользователь добавляет новые темы с помощью команды `/add <тема>`
2. Бот сохраняет темы в базе данных
3. Пользователь может просмотреть список своих тем с помощью команды `/list`
4. Когда пользователь хочет изучить тему, он использует команду `/topic`
5. Бот выбирает случайную тему из списка пользователя, генерирует объяснение с помощью LLM и отправляет его пользователю
6. После отправки объяснения тема удаляется из базы данных
